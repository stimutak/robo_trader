# Session Handoff - IB Gateway API Connection Failure Investigation
**Date:** 2025-11-10 13:50 EST
**Session Focus:** Debug persistent Gateway API handshake timeout issue
**Status:** ⚠️ UNRESOLVED - Needs external help
**Duration:** System has been unable to connect for over 1 month

---

## Executive Summary

The trading system cannot connect to IB Gateway API despite all standard diagnostics showing the Gateway is configured correctly and listening. The issue manifests as a consistent timeout during the API handshake phase, **not** at the TCP connection level.

**Critical Facts:**
- Gateway is running and authenticated
- Gateway is listening on port 4002
- TCP connections succeed (port is reachable)
- API handshake consistently times out after ~30 seconds
- This has been broken for **over 1 month** (not a recent regression)
- Gateway's "Enable ActiveX and Socket Clients" is **permanently enabled** and cannot be disabled

---

## Current System State

### Services Status
- **IB Gateway**: Running (PID 64448), authenticated, listening on port 4002
- **Gateway Version**: IB Gateway 10.40
- **Trading Mode**: Paper trading (port 4002)
- **Gateway Uptime**: ~3.5 hours since last restart
- **Python Environment**: Python 3.11.1 in .venv
- **ib_async Library**: v2.0.1

### Error Symptom
```
API connection failed: TimeoutError()
[Errno 60] Operation timed out
Handshake timed out at 2025-11-10T18:10:23Z
```

The handshake timeout occurs during the `ib.connectAsync()` call, specifically waiting for `apiStart` event.

---

## What We've Verified (All Confirmed Working)

### 1. Gateway Configuration ✓
- Gateway listening on port 4002: `lsof` confirms
- Gateway is authenticated and connected to IBKR servers
- Gateway logs show: `onAuthenticationCompleted authenticated=true`
- Gateway config shows: `ApiOnly=true` in `jts.ini`
- **ActiveX and Socket Clients**: Confirmed enabled and cannot be disabled in Gateway UI

### 2. Network Connectivity ✓
```bash
# TCP connection works
lsof -nP -iTCP:4002
# Shows: JavaAppli 64448 oliver TCP *:4002 (LISTEN)

# Port is reachable
timeout 5 bash -c 'echo > /dev/tcp/127.0.0.1/4002'
# Returns success
```

### 3. No Zombie Connections ✓
```bash
lsof -nP -iTCP:4002 -sTCP:CLOSE_WAIT
# Returns nothing - no zombies present
```

### 4. Code Correctness ✓
- Using `connectAsync()` (not sync version in executor)
- File: `robo_trader/clients/ibkr_subprocess_worker.py:81-83`
```python
await ib.connectAsync(
    host=host, port=port, clientId=client_id, readonly=readonly, timeout=timeout
)
```
- This code worked in the past (handoff from 2025-10-29 shows it was working)

### 5. Virtual Environment ✓
- Fresh venv rebuilt during session
- All dependencies installed correctly
- `ib_async==2.0.1` present and importable

---

## What We've Ruled Out

1. **Gateway API Not Enabled**: ActiveX/Socket Clients is permanently enabled
2. **Wrong Port**: Gateway definitely listening on 4002
3. **Zombie Connections**: None present before or during connection attempts
4. **Firewall**: Local connection (127.0.0.1), no firewall blocking
5. **Client ID Conflicts**: Tried multiple client IDs (1, 555, 999) - all timeout
6. **Code Error**: Verified code matches working version from October handoff
7. **Gateway Not Logged In**: Confirmed authenticated to IBKR servers
8. **Python Environment Issues**: Rebuilt venv, still fails
9. **Library Version**: Using ib_async 2.0.1 (maintained fork, correct version)

---

## Connection Test Results

### Direct Test (Simplified Code)
```python
from ib_async import IB
import asyncio

async def test():
    ib = IB()
    await ib.connectAsync('127.0.0.1', 4002, clientId=999, readonly=True, timeout=10)
    print(f'Connected! Accounts: {ib.managedAccounts()}')

asyncio.run(test())
```

**Result**: TimeoutError after 10 seconds

### System Test (Full Stack)
```bash
./START_TRADER.sh
```

**Result**:
```
4. Testing Gateway connectivity...
   ❌ Gateway connection TIMEOUT
```

---

## What Remains to Investigate

### 1. Gateway Internal Settings
There may be Gateway UI settings not visible via config files or command line that restrict API access:
- Maximum API connections limit
- API client restrictions
- Readonly mode restrictions
- Paper trading API limitations

### 2. IBKR Account Settings
Possible account-level restrictions:
- API access disabled at account level (IBKR website settings)
- Paper trading account not provisioned for API access
- Subscription/permission requirements for API in paper mode

### 3. Gateway Mode/State
- Gateway might be in a mode that doesn't accept API connections
- There might be a Gateway initialization step missing
- Gateway API layer could be in a degraded state despite appearing normal

### 4. ib_async Library Compatibility
- Possible incompatibility between ib_async 2.0.1 and Gateway 10.40
- May need to try ib_insync or different version
- Could be a breaking change in Gateway's API protocol

### 5. macOS-Specific Issues
- macOS 15.0 (Darwin 25.0.0) might have security restrictions
- Sandbox/privacy settings blocking API socket connections
- System Integrity Protection interfering with IPC

---

## Diagnostic Commands

### Check Gateway Status
```bash
# Gateway process
ps aux | grep -i gateway | grep -v grep

# Gateway port
lsof -nP -iTCP:4002

# Gateway logs
tail -100 ~/Jts*/launcher.log | grep -i "api\|client\|socket"

# Gateway config
cat ~/Jts*/jts.ini
```

### Test Connection
```bash
# Quick test
source .venv/bin/activate
python3 -c "
from ib_async import IB
import asyncio

async def test():
    ib = IB()
    try:
        await ib.connectAsync('127.0.0.1', 4002, clientId=999, readonly=True, timeout=5)
        print('SUCCESS')
    except Exception as e:
        print(f'FAILED: {e}')

asyncio.run(test())
"
```

---

## Key Files

### Connection Code
- `robo_trader/clients/ibkr_subprocess_worker.py:49-139` - Connection handler
- `robo_trader/clients/subprocess_ibkr_client.py:344` - Subprocess connect
- `robo_trader/utils/robust_connection.py:547-609` - Connection manager

### Configuration
- `~/Jts*/jts.ini` - Gateway config file
- `.env` - Environment variables (IBKR credentials)
- `robo_trader/config.py` - Application config

### Logs
- `robo_trader.log` - Application logs
- `~/Jts*/launcher.log` - Gateway logs

---

## Timeline

- **2025-10-29**: System was working (see handoff doc)
- **2025-11-09**: Yesterday's commit changed `connectAsync()` to `connect()` in executor (broke it further)
- **2025-11-10**: Reverted to `connectAsync()`, but problem persists
- **User Report**: System has been unable to connect for "over a month"

---

## Attempted Fixes Today (All Failed)

1. Reverted yesterday's commit that changed connection method
2. Rebuilt virtual environment from scratch
3. Reinstalled ib_async library
4. Killed all zombie connections
5. Restarted Gateway multiple times
6. Tried different client IDs
7. Verified code matches working version
8. Checked for firewall/network issues

---

## Questions for Next Investigator

1. **Is there a Gateway UI setting not exposed in config files?**
   - Check File → Global Configuration → API → Settings
   - Are there additional tabs or options not documented?

2. **Does the IBKR account have API access enabled?**
   - Log into account.interactivebrokers.com
   - Check account settings for API permissions
   - Verify paper trading account has API access

3. **Is there a Gateway initialization sequence required?**
   - Does Gateway need a "warmup" period after login?
   - Must certain menu items be clicked before API works?

4. **Could this be a Gateway version issue?**
   - Should we downgrade to an older Gateway version?
   - Is Gateway 10.40 known to have API issues?

5. **Is Python's ib_async compatible with current Gateway?**
   - Should we try ib_insync (archived but might work)?
   - Are there known compatibility issues?

6. **Could there be a macOS permission issue?**
   - Does Gateway need explicit permission in System Settings?
   - Is there a privacy/security setting blocking socket connections?

---

## Recommendations for Next Steps

1. **Check IBKR Account Portal**
   - Log into account.interactivebrokers.com
   - Navigate to account settings
   - Verify API access is enabled for paper trading

2. **Try Alternative Library**
   - Install and test with ib_insync (archived version)
   - Try TWS API directly (Java/C++)
   - This would isolate whether it's a library issue

3. **Contact IBKR Support**
   - They can see server-side logs
   - They can verify if account has API restrictions
   - They may know of Gateway 10.40 issues

4. **Try TWS Instead of Gateway**
   - Gateway might have paper trading API restrictions
   - TWS (Trader Workstation) might work differently

5. **Check macOS Security Settings**
   - System Settings → Privacy & Security
   - Check if Gateway needs explicit permissions
   - Try temporarily disabling SIP (not recommended long-term)

---

## Environment Details

```
OS: macOS 15.0.0 (Darwin 25.0.0)
Python: 3.11.1
ib_async: 2.0.1
Gateway: IB Gateway 10.40
Account: DUN264991 (Paper Trading)
Port: 4002
Client ID: 1 (also tried 555, 999)
Readonly Mode: True
```

---

## Contact Information

- **User**: Oliver
- **Repository**: /Users/oliver/robo_trader
- **Dashboard**: http://localhost:5555 (when running)
- **Gateway API Port**: 4002

---

## Next Session TODO

1. Verify IBKR account API permissions
2. Try connecting with ib_insync library
3. Test with TWS instead of Gateway
4. Check macOS security/privacy settings
5. Consider contacting IBKR support with diagnostic data

---

## Blockers

- Cannot proceed with any trading system functionality without API connection
- All development blocked until connection issue resolved
- Unknown root cause despite extensive diagnostics

---

## Files Modified This Session

```
robo_trader/clients/ibkr_subprocess_worker.py - Reverted to connectAsync()
CLAUDE.md - Updated with note about ActiveX/Socket settings
.venv/ - Rebuilt virtual environment
```

---

## Important Notes

- **DO NOT** suggest checking Gateway's "ActiveX and Socket Clients" setting - it is permanently enabled and cannot be disabled
- **DO NOT** suggest restarting Gateway without user approval - requires 2FA login
- The issue is **NOT** recent - has existed for over a month
- TCP connectivity works - problem is specifically in API handshake layer
- Gateway appears healthy in all diagnostics but refuses API connections

---

## End of Handoff

Good luck to whoever investigates this next. All standard troubleshooting has been exhausted. The root cause is likely in Gateway configuration, IBKR account settings, or an incompatibility between the Python library and Gateway version that's not documented anywhere.
